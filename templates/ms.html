<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeScan | MS Office/HWP 보안 분석</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: { bg: '#0B0F12', card: '#121821', border: 'rgba(255,255,255,0.1)' },
            primary: '#3BA3FF',
            secondary: '#22D3EE'
          }
        }
      }
    }
  </script>
  <style>
    .nav-blur { backdrop-filter: blur(20px); background: rgba(18,24,33,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .nav-link { padding:.5rem .75rem; border-radius:.5rem; font-size:.875rem; color:#d1d5db; transition:.15s; }
    .nav-link:hover { color:#fff; background:rgba(255,255,255,.05); }
    .nav-cta { padding:.5rem .75rem; border-radius:.5rem; font-size:.875rem; font-weight:600; color:#3BA3FF; transition:.15s; }
    .nav-cta:hover { color:#fff; background:rgba(59,163,255,.2); }
    .dropzone { border:2px dashed rgba(255,255,255,0.1); border-radius:1rem; padding:3rem; text-align:center; cursor:pointer; transition:background .15s, border-color .15s; }
    .dropzone.dragover { background:rgba(255,255,255,0.05); border-color:#3BA3FF; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-dark-bg to-slate-900 text-white font-sans">
  <!-- 네비게이션 -->
  <nav id="navbar" class="fixed top-0 w-full z-50 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="/" class="text-2xl font-semibold tracking-tight text-slate-100 hover:opacity-90 transition">SafeScan</a>
        <div class="hidden md:flex items-center space-x-1">
          <a href="/scan/office-hwp" class="nav-link bg-white/5 text-white">MS Office/HWP</a>
          <a href="/pdf" class="nav-link">PDF</a>
          <a href="/archive" class="nav-link">임시</a>
          <div class="w-px h-5 bg-white/10 mx-2"></div>
          <a href="/login" class="nav-cta">로그인</a>
          <a href="/signup" class="nav-cta">회원가입</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- 메인 -->
  <main class="pt-24 pb-20 px-4">
    <section class="max-w-3xl mx-auto bg-dark-card/40 border border-dark-border rounded-2xl p-8">
      <h1 class="text-3xl font-bold mb-6 text-center">MS Office/HWP 보안 스캔</h1>
      <form id="upForm" data-endpoint="{{ request.url_for('scan_ms') }}" class="space-y-6" novalidate>
        <div id="dropzone" class="dropzone relative">
          <div id="emptyState" class="space-y-2">
            <p class="text-lg font-medium">여기에 파일을 끌어다 놓으세요</p>
            <p class="text-gray-400">
              또는 <label for="fileInput" class="text-primary underline cursor-pointer">파일 선택</label>
            </p>
          </div>

          <div id="selectedState" class="hidden text-left">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div id="fileName" class="font-semibold"></div>
                <div id="fileMeta" class="text-sm text-gray-400 mt-1"></div>
              </div>
              <button id="changeFileBtn" type="button" class="text-sm text-primary underline shrink-0">
                다른 파일 선택
              </button>
            </div>
            <div class="mt-4 text-center">
              <button id="dropzoneSubmit" type="submit"
                class="hidden bg-primary hover:bg-blue-600 px-6 py-3 rounded-xl font-semibold transition-all">
                업로드 & 스캔
              </button>
            </div>
          </div>
        </div>
        <input id="fileInput" name="file" type="file"
          accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx,.rtf,.docm,.xlsm,.pptm,.hwp" class="hidden" />
      </form>
    </section>

    <section id="status" class="max-w-3xl mx-auto mt-8 bg-dark-card/40 border border-dark-border rounded-2xl p-6 hidden"></section>
    <section id="summaryCard" class="max-w-3xl mx-auto mt-8 bg-dark-card border border-dark-border rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">AI 요약</h2>
      <div id="llmSummary" class="whitespace-pre-wrap leading-relaxed text-gray-200"></div>
    </section>
    <section id="analysisCard" class="max-w-3xl mx-auto mt-8 bg-dark-card border border-dark-border rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">원본 분석 결과 (JSON)</h2>
      <pre id="analysisJson" class="bg-black/50 text-gray-200 p-4 rounded-lg overflow-auto text-sm"></pre>
    </section>
  </main>

  <footer class="py-12 px-4 border-t border-dark-border">
    <div class="max-w-6xl mx-auto text-center">
      <div class="text-2xl font-semibold mb-3">SafeScan</div>
      <p class="text-sm text-gray-500">© 2025 SafeScan. All rights reserved.</p>
    </div>
  </footer>

  <script>
    window.addEventListener('scroll', () => {
      const navbar = document.getElementById('navbar');
      navbar.classList.toggle('nav-blur', window.scrollY > 50);
    });

    const form = document.getElementById('upForm');
    const endpoint = form.dataset.endpoint;
    const input = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const emptyState = document.getElementById('emptyState');
    const selectedState = document.getElementById('selectedState');
    const fileNameEl = document.getElementById('fileName');
    const fileMetaEl = document.getElementById('fileMeta');
    const changeFileBtn = document.getElementById('changeFileBtn');
    const submitBtn = document.getElementById('dropzoneSubmit');
    const statusEl = document.getElementById('status');
    const summaryCard = document.getElementById('summaryCard');
    const llmSummaryEl = document.getElementById('llmSummary');
    const analysisCard = document.getElementById('analysisCard');
    const analysisJsonEl = document.getElementById('analysisJson');

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return `${(bytes / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
    }

    function showSelectedUI(file) {
      emptyState.classList.add('hidden');
      selectedState.classList.remove('hidden');
      fileNameEl.textContent = file.name;
      fileMetaEl.textContent = `${formatBytes(file.size)} • ${file.type || '유형 미상'}`;
      submitBtn.classList.remove('hidden');
    }

    function showEmptyUI() {
      selectedState.classList.add('hidden');
      emptyState.classList.remove('hidden');
      submitBtn.classList.add('hidden');
      fileNameEl.textContent = '';
      fileMetaEl.textContent = '';
    }

    ['dragenter', 'dragover'].forEach(evt =>
      dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('dragover'); })
    );
    ['dragleave', 'drop'].forEach(evt =>
      dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('dragover'); })
    );

    dropzone.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files && files[0]) { input.files = files; showSelectedUI(files[0]); }
    });
    dropzone.addEventListener('click', () => input.click());
    input.addEventListener('change', () => {
      const f = input.files && input.files[0];
      if (f) showSelectedUI(f); else showEmptyUI();
    });
    changeFileBtn.addEventListener('click', () => input.click());

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const f = input.files && input.files[0];
      if (!f) { alert('파일을 선택하세요.'); return; }

      statusEl.classList.remove('hidden');
      statusEl.innerHTML = '<span class="text-gray-300">업로드 중...</span>';
      submitBtn.disabled = true;
      submitBtn.textContent = '업로드 중...';

      try {
        const fd = new FormData();
        fd.append('file', f, f.name);
        const res = await fetch(endpoint, { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`서버 오류: ${res.status}`);
        const data = await res.json();

        statusEl.innerHTML = `<span class="text-green-400 font-medium">완료</span> — <code>${data.filename || f.name}</code>`;
        const llm = (data.llm_summary || '').trim();
        if (llm) { llmSummaryEl.textContent = llm; summaryCard.classList.remove('hidden'); }
        else summaryCard.classList.add('hidden');

        analysisJsonEl.textContent = JSON.stringify(data.analysis, null, 2);
        analysisCard.classList.remove('hidden');
      } catch (err) {
        statusEl.innerHTML = `<div class="text-red-400 whitespace-pre-wrap">${err.message || err}</div>`;
        summaryCard.classList.add('hidden');
        analysisCard.classList.add('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '업로드 & 스캔';
      }
    });

    showEmptyUI();
  </script>
</body>
</html>
